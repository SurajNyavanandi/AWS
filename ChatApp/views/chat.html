<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="header">
                <h1>Chat App</h1>
            </div>
            <div class="users-cont">
                <h3>Online Users</h3>
                <div id="users" class="users-list"></div>
            </div>
            <div class="groups-cont">
                <h3>Groups</h3>
                <div class="group-buttons">
                    <button onclick="createGroup()">Create Group</button>
                    <button onclick="viewGroups()">View Groups</button>
                    <button onclick="addUserToGroup()">Add User to Group</button>
                </div>
                <div id="groups" class="groups-list"></div>
            </div>
            <button onclick="logout()">Logout</button>
        </aside>
        <main class="chat-cont">
            <div class="msg-cont" id="msg-cont"></div>
            <div class="input-cont">
                <input type="text" id="msg-input" placeholder="Type your message...">
                <input type="submit" value="Send" onclick="sendMessage()">
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const socket = io();

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('newMessage', (message) => {
            const msgContainer = document.getElementById('msg-cont');
            const msgElement = document.createElement('div');
            msgElement.classList.add('message');
            msgElement.innerHTML = `<strong>${message.User.name}:</strong> ${message.message}`;
            msgContainer.appendChild(msgElement);
        });

        function sendMessage() {
            const msg = document.querySelector('#msg-input').value;
            axios.post('http://localhost:1500/user/publicgroup', { message: msg }, {
                headers: { 'Authorization': token }
            })
            .then(response => {
                document.querySelector('#msg-input').value = '';
                socket.emit('sendMessage', response.data.newMessage);
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        }

        function fetchLoggedInUsers() {
            axios.get('http://localhost:1500/user/logged-in-users')
                .then(response => {
                    const usersList = document.getElementById('users');
                    usersList.innerHTML = ''; 
                    response.data.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.classList.add('user');
                        userElement.textContent = user.name;
                        usersList.appendChild(userElement);
                    });
                })
                .catch(error => {
                    console.error('Error fetching logged-in users:', error);
                });
        }

        function createGroup() {
            const groupName = prompt('Enter group name:');
            if (groupName) {
                axios.post('http://localhost:1500/group/create', { name: groupName }, {
                    headers: { 'Authorization': token }
                })
                .then(response => {
                    alert('Group created successfully');
                    viewGroups(); 
                })
                .catch(error => {
                    console.error('Error creating group:', error);
                    alert('Failed to create group');
                });
            }
        }

        function viewGroups() {
            axios.get('http://localhost:1500/group/user-groups', {
                headers: { 'Authorization': token }
            })
            .then(response => {
                const groups = response.data;
                const groupsContainer = document.getElementById('groups');
                groupsContainer.innerHTML = ''; 

                if (groups.message) {
                    groupsContainer.innerHTML = `<p>${groups.message}</p>`;
                } else {
                    groups.forEach(group => {
                        const groupElement = document.createElement('div');
                        groupElement.classList.add('group');
                        groupElement.innerHTML = `<strong>${group.name}</strong>`;
                        groupsContainer.appendChild(groupElement);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching groups:', error);
            });
        }

        function logout() {
            axios.post('http://localhost:1500/user/logout', {}, {
                headers: { 'Authorization': token }
            })
            .then(response => {
                localStorage.removeItem('token');
                window.location.href = '/login';
            })
            .catch(error => {
                console.error('Error logging out:', error);
            });
        }

        window.onload = fetchLoggedInUsers;
    </script>
</body>
</html>
